<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>–ß–∏‚Äë–§–∞–Ω—å ¬∑ –ò—Ç–æ–≥–∏ + –ü—Ä–µ–º–∏—è</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #0b0c10;
      --card: #111318;
      --text: #e8edf5;
      --mut: #a7b0bf;
      --border: #1f2330;
      --accent: #60a5fa;
      --good: #22c55e;
      --bad: #ef4444;
      --warn: #f59e0b;
      --btn-bg: #0e1726;
      --btn-border: #264063;
      --btn-text: #e8edf5;
      --btn-hover: #122039;
      --btn-primary-bg: #0b1c32;
      --btn-primary-border: #3b82f6;
      --btn-danger-bg: #1a0f10;
      --btn-danger-border: #ef4444;
      --input-bg: #0f1219;
      --input-text: #e8edf5;
      transition: background-color 1.1s ease, color 1.1s ease;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font: 14px/1.45 -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 12px;
      padding-bottom: 70px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 16px;
      padding: 16px;
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
    }
    
    h1 { font-size: 18px; margin: 0 0 4px; }
    .sub { color: var(--mut); font-size: 12px; }
    
    .controls {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .control-group {
      flex: 1;
      min-width: 120px;
    }
    
    select, input, button, textarea {
      background: var(--input-bg);
      color: var(--input-text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      width: 100%;
      font-size: 14px;
    }
    
    button {
      cursor: pointer;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-text);
      border-radius: 12px;
      transition: .2s ease;
    }
    
    button:hover {
      transform: translateY(-1px);
      background: var(--btn-hover);
    }
    
    .btn-primary {
      border-color: var(--btn-primary-border);
      background: var(--btn-primary-bg);
    }
    
    .btn-danger {
      border-color: var(--btn-danger-border);
      background: var(--btn-danger-bg);
    }
    
    .grid {
      display: grid;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .grid.kpi {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .grid.two {
      grid-template-columns: 1fr;
    }
    
    .grid.three {
      grid-template-columns: 1fr;
    }
    
    @media (min-width: 480px) {
      .grid.two {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      position: relative;
    }
    
    .title { font-size: 12px; color: var(--mut); margin-bottom: 6px; }
    .knum { font-weight: 700; font-size: 22px; margin: 4px 0; }
    .mut { color: var(--mut); font-size: 11px; }
    .mono { font-family: 'Courier New', monospace; font-size: 11px; }
    
    .pill {
      display: inline-flex;
      align-items: center;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
    }
    
    .pill.good { border-color: #1f5132; color: #34d399; background: #0d1f14; }
    .pill.warn { border-color: #5a410e; color: #fbbf24; background: #1d1507; }
    .pill.bad { border-color: #512228; color: #f87171; background: #1a0f10; }
    
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid var(--border);
    }
    
    .badge.healthy { background: #0d1f14; color: #34d399; border-color: #1f5132; }
    .badge.middle { background: #1d1507; color: #fbbf24; border-color: #5a410e; }
    .badge.risky { background: #1a0f10; color: #f87171; border-color: #512228; }
    
    .bar {
      height: 6px;
      background: #10161f;
      border-radius: 99px;
      overflow: hidden;
      margin: 8px 0;
    }
    
    .bar > i {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #60a5fa);
      border-radius: 99px;
    }
    
    .split { 
      display: flex; 
      gap: 12px; 
      align-items: center; 
      justify-content: space-between; 
      flex-wrap: wrap; 
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    .table th, .table td {
      padding: 8px 6px;
      border-bottom: 1px dashed var(--border);
      text-align: left;
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin: 20px 0 12px 0;
      color: var(--text);
    }
    
    .tg-button {
      width: 100%;
      padding: 12px;
      background: var(--btn-primary-bg);
      color: var(--btn-text);
      border: 1px solid var(--btn-primary-border);
      border-radius: 12px;
      font-size: 14px;
      margin: 6px 0;
      cursor: pointer;
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin: 12px 0;
    }
    
    .file-input {
      display: none;
    }
    
    /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 360px) {
      .grid.kpi {
        grid-template-columns: 1fr;
      }
      
      .controls {
        flex-direction: column;
      }
      
      .action-buttons {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üçú –ß–∏-–§–∞–Ω—å ‚Äî –ò—Ç–æ–≥–∏ + –ü—Ä–µ–º–∏—è</h1>
    <div class="sub">3% √ó –í—ã—Ä—É—á–∫–∞ √ó ramp(95‚Äì100%) √ó Quality</div>
  </div>

  <div class="controls">
    <div class="control-group">
      <label class="mut">–ü–µ—Ä–∏–æ–¥</label>
      <input type="month" id="m" />
    </div>
    <div class="control-group">
      <label class="mut">–§–∏–ª–∏–∞–ª</label>
      <select id="b"></select>
    </div>
  </div>

  <div class="action-buttons">
    <button class="btn-primary" id="edit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    <button id="btn-compare">üìä –°—Ä–∞–≤–Ω–∏—Ç—å</button>
    <button id="export">üì§ –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
    <button class="btn-primary" id="import">üì• –ò–º–ø–æ—Ä—Ç JSON</button>
    <button class="btn-danger" id="reset">üîÑ –°–±—Ä–æ—Å</button>
  </div>

  <input type="file" id="fileInput" class="file-input" accept=".json" />

  <div class="grid kpi" id="kpi-grid"></div>

  <div class="grid three">
    <section class="card">
      <div class="split">
        <div>
          <div class="title">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞</div>
          <div class="knum" id="kpi-fulfill-label">‚Äî</div>
        </div>
        <div class="pill" id="pill-gap">–ì—ç–ø: ‚Äî</div>
      </div>
      <div class="bar"><i id="bar-fulfill" style="width:0%"></i></div>
      <div style="display: flex; justify-content: space-between; font-size: 11px;">
        <span>–§–∞–∫—Ç: <span id="lbl-rev-fact" class="mono">‚Äî</span></span>
        <span>–ü–ª–∞–Ω: <span id="lbl-rev-plan" class="mono">‚Äî</span></span>
      </div>
    </section>

    <section class="card">
      <div class="split">
        <div>
          <div class="title">–î–æ–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏</div>
          <div class="knum" id="kpi-delivery-label">‚Äî</div>
        </div>
        <div class="pill" id="delivery-pill">‚Äî</div>
      </div>
      <div class="mut">–¶–µ–ª—å: 35‚Äì45%</div>
    </section>

    <section class="card">
      <div class="split">
        <div>
          <div class="title">Health Score</div>
          <div class="knum"><span id="health-score">‚Äî</span></div>
        </div>
        <span id="health-badge" class="badge">‚Äî</span>
      </div>
      <div class="mut">–ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º</div>
    </section>
  </div>

  <section class="card">
    <div class="split">
      <div>
        <div class="title">–ü—Ä–µ–º–∏—è –∫ –≤—ã–ø–ª–∞—Ç–µ</div>
        <div class="knum" id="bonus-amount">‚Äî</div>
        <div class="mut" id="bonus-info">–ë–∞–∑–∞: 3% –æ—Ç –≤—ã—Ä—É—á–∫–∏ √ó –†–∞–º–ø–∞ √ó Quality</div>
      </div>
      <div id="bonus-elig" class="pill">‚Äî</div>
    </div>
  </section>

  <section class="grid two">
    <div class="card">
      <div class="title">–†–µ–π—Ç–∏–Ω–≥ —Ñ–∏–ª–∏–∞–ª–æ–≤</div>
      <table class="table" id="tbl-rating">
        <thead><tr><th>#</th><th>–§–∏–ª–∏–∞–ª</th><th>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <div class="title">–ü—Ä–æ–±–ª–µ–º—ã ‚Üí –†–µ—à–µ–Ω–∏—è</div>
      <textarea id="txt-notes" class="mono" style="width:100%; min-height:100px; margin-top:8px;" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–º–µ—Ç–∫–∏..."></textarea>
      <button class="tg-button" id="btn-copy" style="margin-top:8px;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —á–µ–∫-–ª–∏—Å—Ç</button>
    </div>
  </section>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const fmt = new Intl.NumberFormat('ru-RU');
    const rub = n => (isFinite(n) ? fmt.format(Math.round(n)) + ' ‚ÇΩ' : '‚Äî');
    const pct = x => (isFinite(x) ? (Math.round(x * 1000) / 10) + '%' : '‚Äî');
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    const tg = window.Telegram?.WebApp;

    // –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    let DATA = {
      "month": "2025-09",
      "branches": [
        {
          "branch": "–¢–∏—Ö–∞—è",
          "month": "2025-09",
          "revenue_plan": 2100000,
          "revenue_fact": 2100000,
          "avg_check": 0,
          "guests": 0,
          "delivery_share": 0.43,
          "fot_amount": 350000,
          "reviews_rating_avg": 4.37,
          "reviews_count_neg": 13,
          "late_count": 0,
          "auditor_score": 70,
          "mystery_score": 100,
          "control_purchase_score": 85,
          "notes": ""
        },
        {
          "branch": "–¢–æ–±–æ–ª—å—Å–∫–∞—è",
          "month": "2025-09",
          "revenue_plan": 3500000,
          "revenue_fact": 3500000,
          "avg_check": 0,
          "guests": 0,
          "delivery_share": 0.43,
          "fot_amount": 750000,
          "reviews_rating_avg": 4.51,
          "reviews_count_neg": 10,
          "late_count": 0,
          "auditor_score": 70,
          "mystery_score": 100,
          "control_purchase_score": 95,
          "notes": ""
        }
      ]
    };
    const START = JSON.parse(JSON.stringify(DATA));

    let CFG = {
      base_rate: 0.03,
      ramp: { min: 0.95, max: 1.00 },
      weights: { auditor: 0.35, control: 0.30, mystery: 0.20, reviews: 0.15 }
    };

    let TH = {
      fulfillment: { warn: 0.95, good: 1.0 },
      delivery: { min: 0.35, max: 0.45 },
      reviews: { good: 4.4, warn: 4.2 },
      auditor: { good: 85, warn: 80 },
      mystery: { good: 80, warn: 75 },
      control: { good: 85, warn: 80 },
      lateness: { good: 5, warn: 8 },
      negReviews: { good: 6, warn: 10 },
      fotShare: { good: [0.18, 0.22], warn: [0.22, 0.25] }
    };

    let editMode = false;

    function init() {
      if (tg) {
        tg.ready();
        tg.expand();
        tg.MainButton.setText("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ").hide();
        
        if (tg.platform !== 'tdesktop') {
          tg.BackButton.show();
          tg.BackButton.onClick(() => {
            tg.showConfirm("–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?", (ok) => {
              if (ok) tg.close();
            });
          });
        }
      }

      $('#m').value = DATA.month;
      updateBranchSelect();
      
      render();
      fillRating();
    }

    function updateBranchSelect() {
      const s = $('#b');
      s.innerHTML = '';
      DATA.branches.forEach((b, i) => {
        const o = document.createElement('option');
        o.value = i;
        o.textContent = b.branch;
        s.appendChild(o);
      });
      s.value = 0;
    }

    function curr() {
      return DATA.branches[+$('#b').value || 0];
    }

    function qualityScore(b) {
      const w = CFG.weights;
      const auditor = (+b.auditor_score || 0) / 100;
      const control = (+b.control_purchase_score || 0) / 100;
      const mystery = (+b.mystery_score || 0) / 100;
      const reviews = Math.max(0, Math.min(1, ((+b.reviews_rating_avg || 0) - 3.5) / 1.5));
      const score = auditor * w.auditor + control * w.control + mystery * w.mystery + reviews * w.reviews;
      return { score, details: { auditor, control, mystery, reviews } };
    }

    function rampCoef(plan, fact) {
      const f = plan ? fact / plan : 0;
      const r = CFG.ramp;
      if (f < r.min) return 0;
      if (f >= r.max) return 1;
      const span = (r.max - r.min) || 0.05;
      return (f - r.min) / span;
    }

    function compute(b) {
      const base = (+b.revenue_fact || 0) * CFG.base_rate;
      const ramp = rampCoef(+b.revenue_plan || 0, +b.revenue_fact || 0);
      const q = qualityScore(b);
      const payout = base * ramp * q.score;
      const effRate = CFG.base_rate * ramp * q.score;
      const fulfill = (+b.revenue_plan || 0) ? (+b.revenue_fact || 0) / (+b.revenue_plan || 0) : 0;
      return { base, ramp, quality: q.score, effRate, payout, fulfill };
    }

    function statusClass(value, metric) {
      switch(metric) {
        case 'fulfillment':
          if (value >= TH.fulfillment.good) return 'good';
          if (value >= TH.fulfillment.warn) return 'warn';
          return 'bad';
        case 'delivery':
          if (value >= TH.delivery.min && value <= TH.delivery.max) return 'good';
          if (Math.abs(value - TH.delivery.min) <= 0.05 || Math.abs(value - TH.delivery.max) <= 0.05) return 'warn';
          return 'bad';
        case 'reviews':
          if (value >= TH.reviews.good) return 'good';
          if (value >= TH.reviews.warn) return 'warn';
          return 'bad';
        case 'auditor':
          if (value >= TH.auditor.good) return 'good';
          if (value >= TH.auditor.warn) return 'warn';
          return 'bad';
        case 'mystery':
          if (value >= TH.mystery.good) return 'good';
          if (value >= TH.mystery.warn) return 'warn';
          return 'bad';
        case 'control':
          if (value >= TH.control.good) return 'good';
          if (value >= TH.control.warn) return 'warn';
          return 'bad';
        case 'lateness':
          if (value <= TH.lateness.good) return 'good';
          if (value <= TH.lateness.warn) return 'warn';
          return 'bad';
        case 'negReviews':
          if (value <= TH.negReviews.good) return 'good';
          if (value <= TH.negReviews.warn) return 'warn';
          return 'bad';
        case 'fotShare':
          if (value >= TH.fotShare.good[0] && value <= TH.fotShare.good[1]) return 'good';
          if (value > TH.fotShare.good[1] && value <= TH.fotShare.warn[1]) return 'warn';
          if (value < TH.fotShare.good[0] && value >= 0.15) return 'warn';
          return 'bad';
      }
      return 'good';
    }

    function healthScore(b, fotShare) {
      const plan = +b.revenue_plan || 0, fact = +b.revenue_fact || 0;
      const fulfill = plan ? fact / plan : 0;
      const w = { fulfill: 0.28, reviews: 0.16, auditor: 0.12, mystery: 0.12, control: 0.10, fot: 0.12, late: 0.05, delivery: 0.05 };
      
      function normBand(x, good, warn) { return x >= good ? 1 : (x >= warn ? 0.7 : 0.35); }
      function normBandRev(x, good, warn) { return x <= good ? 1 : (x <= warn ? 0.7 : 0.35); }
      function normCorridor(x, min, max) { 
        if (x >= min && x <= max) return 1; 
        if (Math.abs(x - min) <= 0.05 || Math.abs(x - max) <= 0.05) return 0.7; 
        return 0.35; 
      }

      const nFulfill = clamp(fulfill / 1.0, 0, 1);
      const nReviews = normBand(b.reviews_rating_avg || 0, TH.reviews.good, TH.reviews.warn);
      const nAud = normBand(b.auditor_score || 0, TH.auditor.good, TH.auditor.warn);
      const nMy = normBand(b.mystery_score || 0, TH.mystery.good, TH.mystery.warn);
      const nControl = normBand(b.control_purchase_score || 0, TH.control.good, TH.control.warn);
      const nFot = (fotShare >= TH.fotShare.good[0] && fotShare <= TH.fotShare.good[1]) ? 1 : (fotShare <= TH.fotShare.warn[1] ? 0.7 : 0.35);
      const nLate = normBandRev(b.late_count || 0, TH.lateness.good, TH.lateness.warn);
      const nDel = normCorridor(b.delivery_share || 0, TH.delivery.min, TH.delivery.max);

      const total = (nFulfill * w.fulfill + nReviews * w.reviews + nAud * w.auditor + nMy * w.mystery + nControl * w.control + nFot * w.fot + nLate * w.late + nDel * w.delivery) * 100;
      return total;
    }

    function badgeByClass(cls) {
      if (cls === 'good') return ['healthy', '–û–ö'];
      if (cls === 'warn') return ['middle', '–í–Ω–∏–º–∞–Ω–∏–µ'];
      return ['risky', '–ü—Ä–æ–±–ª–µ–º–∞'];
    }

    function render() {
      const b = curr();
      const g = $('#kpi-grid');
      g.innerHTML = '';

      const fotShare = (+b.fot_amount || 0) / ((+b.revenue_fact) || 1);
      const neg = +b.reviews_count_neg || 0;

      const cards = [
        { t: "–í—ã—Ä—É—á–∫–∞ (–§–∞–∫—Ç)", v: rub(b.revenue_fact), s: `–ü–ª–∞–Ω: ${rub(b.revenue_plan)}`, cls: statusClass((+b.revenue_fact || 0) / ((+b.revenue_plan) || 1), 'fulfillment') },
        { t: "–°—Ä–µ–¥–Ω–∏–π —á–µ–∫", v: fmt.format(b.avg_check) + ' ‚ÇΩ', s: `–ì–æ—Å—Ç–µ–π: ${fmt.format(b.guests)}`, cls: null },
        { t: "–§–û–¢", v: rub(b.fot_amount), s: `–î–æ–ª—è –§–û–¢: ${(Math.round(fotShare * 1000) / 10)}%`, cls: statusClass(fotShare, 'fotShare') },
        { t: "–û—Ç–∑—ã–≤—ã", v: (b.reviews_rating_avg ?? '‚Äî') + " ‚òÖ", s: "–ù–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö: " + neg, cls: mergeWorst(statusClass(b.reviews_rating_avg, 'reviews'), statusClass(neg, 'negReviews')) },
        { t: "–ê—É–¥–∏—Ç", v: (b.auditor_score ?? '‚Äî') + "/100", s: "–ö–æ–Ω—Ç—Ä–æ–ª—å: " + (b.control_purchase_score ?? '‚Äî') + "/100", cls: mergeWorst(statusClass(b.auditor_score, 'auditor'), statusClass(b.control_purchase_score, 'control')) },
        { t: "–¢–∞–π–Ω—ã–π –≥–æ—Å—Ç—å", v: (b.mystery_score ?? '‚Äî') + "/100", s: "", cls: statusClass(b.mystery_score, 'mystery') },
      ];

      cards.forEach(c => {
        const el = document.createElement('div');
        el.className = 'card';
        const pill = c.cls ? `<div class="pill ${c.cls}">${labelFor(c.cls)}</div>` : '';
        el.innerHTML = `
          <div class="title">${c.t}</div>
          <div class="knum">${c.v}</div>
          <div class="mut">${c.s || ''}</div>
          ${pill}
        `;
        g.appendChild(el);
      });

      // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
      const plan = +b.revenue_plan || 0, fact = +b.revenue_fact || 0;
      const fulfill = plan ? fact / plan : 0;
      
      $('#kpi-fulfill-label').textContent = pct(fulfill);
      $('#lbl-rev-fact').textContent = rub(fact);
      $('#lbl-rev-plan').textContent = rub(plan);
      $('#bar-fulfill').style.width = clamp(fulfill * 100, 0, 150) + '%';
      
      const gapEl = $('#pill-gap');
      gapEl.textContent = (fact >= plan ? "+" + rub(fact - plan) : "‚àí" + rub(Math.abs(fact - plan)));
      gapEl.className = 'pill ' + (fact >= plan ? 'good' : (fulfill >= TH.fulfillment.warn ? 'warn' : 'bad'));

      // –î–æ—Å—Ç–∞–≤–∫–∞
      $('#kpi-delivery-label').textContent = pct(b.delivery_share);
      const deliveryPill = $('#delivery-pill');
      deliveryPill.textContent = labelFor(statusClass(b.delivery_share, 'delivery'));
      deliveryPill.className = 'pill ' + statusClass(b.delivery_share, 'delivery');

      // Health Score
      const score = healthScore(b, fotShare);
      $('#health-score').textContent = Math.round(score);
      const [badgeCls, badgeText] = badgeByClass(score >= 80 ? 'good' : (score >= 65 ? 'warn' : 'bad'));
      const hb = $('#health-badge');
      hb.className = 'badge ' + badgeCls;
      hb.textContent = badgeText;

      // Notes
      $('#txt-notes').value = (b.notes || '');

      // Bonus
      const r = compute(b);
      $('#bonus-amount').textContent = rub(r.payout);
      $('#bonus-info').textContent = `–ë–∞–∑–∞: ${rub(r.base)} ¬∑ –†–∞–º–ø–∞: ${Math.round(r.ramp * 100)}% ¬∑ Quality: ${Math.round(r.quality * 100)}%`;
      const st = r.ramp === 0 ? 'bad' : (r.ramp < 1 ? 'warn' : 'good');
      const tx = r.ramp === 0 ? '–ù–µ–¥–æ–ø—É—Å–∫' : (r.ramp < 1 ? '–ß–∞—Å—Ç–∏—á–Ω–æ' : '–ü–æ–ª–Ω—ã–π');
      const el = $('#bonus-elig');
      el.className = 'pill ' + st;
      el.textContent = tx;
    }

    function labelFor(cls) { return cls === 'good' ? '–û–ö' : (cls === 'warn' ? '–í–Ω–∏–º–∞–Ω–∏–µ' : '–ü—Ä–æ–±–ª–µ–º–∞'); }
    function mergeWorst(a, b) { 
      if (a === 'bad' || b === 'bad') return 'bad'; 
      if (a === 'warn' || b === 'warn') return 'warn'; 
      return 'good'; 
    }

    function fillRating() {
      const tbody = $('#tbl-rating tbody');
      tbody.innerHTML = '';
      
      const items = DATA.branches.map(b => {
        const plan = +b.revenue_plan || 0, fact = +b.revenue_fact || 0;
        const fulfill = plan ? fact / plan : 0;
        return { name: b.branch, plan, fact, fulfill };
      }).sort((a, b) => b.fulfill - a.fulfill);

      items.forEach((it, idx) => {
        const tr = document.createElement('tr');
        const medal = idx === 0 ? 'ü•á' : (idx === 1 ? 'ü•à' : (idx === 2 ? 'ü•â' : ''));
        tr.innerHTML = `
          <td>${medal} ${idx + 1}</td>
          <td>${it.name}</td>
          <td>${pct(it.fulfill)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function toggleEdit() {
      editMode = !editMode;
      $('#edit').textContent = editMode ? 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
      
      const b = curr();
      const grid = $('#kpi-grid');
      
      if (editMode) {
        grid.innerHTML = '';
        
        const fields = [
          ['revenue_plan', '–ü–ª–∞–Ω –≤—ã—Ä—É—á–∫–∏, ‚ÇΩ', 'number'],
          ['revenue_fact', '–§–∞–∫—Ç –≤—ã—Ä—É—á–∫–∏, ‚ÇΩ', 'number'],
          ['avg_check', '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫, ‚ÇΩ', 'number'],
          ['guests', '–ì–æ—Å—Ç–µ–π, —á–µ–ª', 'number'],
          ['delivery_share', '–î–æ–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ (0-1)', 'number'],
          ['fot_amount', '–§–û–¢, ‚ÇΩ', 'number'],
          ['reviews_rating_avg', '–û—Ç–∑—ã–≤—ã (1-5)', 'number'],
          ['reviews_count_neg', '–ù–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤', 'number'],
          ['late_count', '–û–ø–æ–∑–¥–∞–Ω–∏—è', 'number'],
          ['auditor_score', '–ê—É–¥–∏—Ç (0-100)', 'number'],
          ['control_purchase_score', '–ö–æ–Ω—Ç—Ä–æ–ª—å (0-100)', 'number'],
          ['mystery_score', '–¢–∞–π–Ω—ã–π –≥–æ—Å—Ç—å (0-100)', 'number']
        ];

        fields.forEach(([key, label, type]) => {
          const val = b[key] ?? '';
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="title">${label}</div>
            <input type="${type}" data-key="${key}" value="${val}" 
                   style="width: 100%; margin-top: 8px;" />
          `;
          grid.appendChild(card);
        });
        
        if (tg) {
          tg.MainButton.show();
          tg.MainButton.onClick(saveEditData);
        }
      } else {
        saveEditData();
      }
    }

    function saveEditData() {
      $$('#kpi-grid input').forEach(inp => {
        const k = inp.dataset.key;
        let v = inp.value;
        if (k === 'delivery_share' || k === 'reviews_rating_avg') {
          curr()[k] = parseFloat(v) || 0;
        } else {
          curr()[k] = +v || 0;
        }
      });
      
      if (tg) {
        tg.MainButton.hide();
        tg.showPopup({
          title: "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ",
          message: "–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã",
          buttons: [{ type: "ok" }]
        });
      }
      
      render();
      fillRating();
    }

    function copyChecklist() {
      const txt = $('#txt-notes').value.trim();
      if (!txt) { 
        showAlert('–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞ –∑–∞–º–µ—Ç–æ–∫.');
        return; 
      }
      
      const lines = txt.split(/\n+/).map(s => s.replace(/^[-‚Äî‚Ä¢\s]+/, '').trim()).filter(Boolean);
      const checklist = lines.map(s => `‚ñ° ${s}`).join('\n');
      
      if (tg) {
        tg.sendData(JSON.stringify({ type: 'checklist', data: checklist }));
        tg.showPopup({
          title: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ",
          message: "–ß–µ–∫-–ª–∏—Å—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é",
          buttons: [{ type: "ok" }]
        });
      } else {
        navigator.clipboard.writeText(checklist);
        showAlert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä:\n\n' + checklist);
      }
    }

    function exportData() {
      const dataStr = JSON.stringify(DATA, null, 2);
      if (tg) {
        tg.sendData(JSON.stringify({ type: 'export', data: DATA }));
        tg.showPopup({
          title: "–≠–∫—Å–ø–æ—Ä—Ç",
          message: "–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Telegram",
          buttons: [{ type: "ok" }]
        });
      } else {
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'chifan-data.json';
        a.click();
        URL.revokeObjectURL(url);
        showAlert('JSON —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω');
      }
    }

    function importData() {
      $('#fileInput').click();
    }

    function handleFileImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          
          // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
          if (!importedData.branches || !Array.isArray(importedData.branches)) {
            throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç branches');
          }
          
          if (importedData.branches.length === 0) {
            throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ñ–∏–ª–∏–∞–ª–∞—Ö');
          }

          DATA = importedData;
          $('#m').value = DATA.month;
          updateBranchSelect();
          render();
          fillRating();
          
          showAlert(`–£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${DATA.branches.length} —Ñ–∏–ª–∏–∞–ª–æ–≤`, '–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö');
          
        } catch (error) {
          showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ JSON: ' + error.message, '–û—à–∏–±–∫–∞');
        }
      };
      reader.readAsText(file);
      
      // –°–±—Ä–æ—Å input –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞
      event.target.value = '';
    }

    function showCompare() {
      const a = DATA.branches.find(x => x.branch === '–¢–∏—Ö–∞—è') || DATA.branches[0];
      const b = DATA.branches.find(x => x.branch === '–¢–æ–±–æ–ª—å—Å–∫–∞—è') || DATA.branches[1] || DATA.branches[0];
      
      const comparison = `
üè™ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ñ–∏–ª–∏–∞–ª–æ–≤:

–¢–∏—Ö–∞—è vs –¢–æ–±–æ–ª—å—Å–∫–∞—è

üìä –í—ã—Ä—É—á–∫–∞: ${rub(a.revenue_fact)} vs ${rub(b.revenue_fact)}
üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: ${pct(a.revenue_fact/a.revenue_plan)} vs ${pct(b.revenue_fact/b.revenue_plan)}
üí∞ –ü—Ä–µ–º–∏—è: ${rub(compute(a).payout)} vs ${rub(compute(b).payout)}
‚≠ê –û—Ç–∑—ã–≤—ã: ${a.reviews_rating_avg}‚òÖ vs ${b.reviews_rating_avg}‚òÖ
üì¶ –î–æ—Å—Ç–∞–≤–∫–∞: ${pct(a.delivery_share)} vs ${pct(b.delivery_share)}
      `.trim();
      
      showAlert(comparison, '–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ñ–∏–ª–∏–∞–ª–æ–≤');
    }

    function showAlert(message, title = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è') {
      if (tg) {
        tg.showPopup({
          title: title,
          message: message,
          buttons: [{ type: "ok" }]
        });
      } else {
        alert(title + '\n\n' + message);
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    $('#b').addEventListener('change', render);
    $('#m').addEventListener('change', e => {
      DATA.month = e.target.value;
      DATA.branches.forEach(x => x.month = DATA.month);
      render();
      fillRating();
    });
    
    $('#edit').addEventListener('click', toggleEdit);
    $('#btn-compare').addEventListener('click', showCompare);
    $('#export').addEventListener('click', exportData);
    $('#import').addEventListener('click', importData);
    $('#btn-copy').addEventListener('click', copyChecklist);
    $('#fileInput').addEventListener('change', handleFileImport);
    
    $('#reset').addEventListener('click', () => {
      if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫ –¥–µ–º–æ-–≤–µ—Ä—Å–∏–∏?')) {
        DATA = JSON.parse(JSON.stringify(START));
        init();
        showAlert('–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã –∫ –¥–µ–º–æ-–≤–µ—Ä—Å–∏–∏');
      }
    });

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    init();
  </script>
</body>
</html>
