<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>–ß–∏‚Äë–§–∞–Ω—å –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #0b0c10;
      --card: #111318;
      --text: #e8edf5;
      --mut: #a7b0bf;
      --border: #1f2330;
      --accent: #60a5fa;
      --good: #22c55e;
      --bad: #ef4444;
      --warn: #f59e0b;
      --btn-bg: #0e1726;
      --btn-border: #264063;
      --btn-text: #e8edf5;
      --btn-hover: #122039;
      --btn-primary-bg: #0b1c32;
      --btn-primary-border: #3b82f6;
      --btn-danger-bg: #1a0f10;
      --btn-danger-border: #ef4444;
      --input-bg: #0f1219;
      --input-text: #e8edf5;
      transition: background-color 0.6s ease, color 0.6s ease;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font: 16px/1.45 -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 16px;
      padding-bottom: 60px; /* –î–ª—è –∫–Ω–æ–ø–∫–∏ Telegram */
    }
    
    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 16px;
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
    }
    
    h1 { font-size: 20px; margin: 0 0 6px; }
    .sub { color: var(--mut); font-size: 13px; }
    
    .grid {
      display: grid;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .grid.kpi {
      grid-template-columns: repeat(2, 1fr);
    }
    
    @media (max-width: 480px) {
      .grid.kpi {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      position: relative;
    }
    
    .title { font-size: 13px; color: var(--mut); margin-bottom: 8px; }
    .knum { font-weight: 700; font-size: 24px; margin: 4px 0; }
    .mut { color: var(--mut); font-size: 12px; }
    .mono { font-family: 'Courier New', monospace; font-size: 12px; }
    
    .pill {
      display: inline-block;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      margin-top: 8px;
    }
    
    .pill.good { border-color: #1f5132; color: #34d399; background: #0d1f14; }
    .pill.warn { border-color: #5a410e; color: #fbbf24; background: #1d1507; }
    .pill.bad { border-color: #512228; color: #f87171; background: #1a0f10; }
    
    .bar {
      height: 6px;
      background: #10161f;
      border-radius: 99px;
      overflow: hidden;
      margin: 8px 0;
    }
    
    .bar > i {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #60a5fa);
      border-radius: 99px;
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin: 20px 0 12px 0;
      color: var(--text);
    }
    
    .tg-button {
      width: 100%;
      padding: 12px;
      background: var(--btn-primary-bg);
      color: var(--btn-text);
      border: 1px solid var(--btn-primary-border);
      border-radius: 12px;
      font-size: 16px;
      margin: 8px 0;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>–ß–∏-–§–∞–Ω—å –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
    <div class="sub">Telegram Mini App ‚Ä¢ –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>
  </div>

  <div class="grid kpi" id="kpi-grid">
    <!-- KPI –∫–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã JavaScript -->
  </div>

  <div class="card">
    <div class="title">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–æ –≤—ã—Ä—É—á–∫–µ</div>
    <div class="knum" id="kpi-fulfill-label">‚Äî</div>
    <div class="bar">
      <i id="bar-fulfill" style="width: 0%"></i>
    </div>
    <div style="display: flex; justify-content: space-between; font-size: 12px;">
      <span>–§–∞–∫—Ç: <span id="lbl-rev-fact" class="mono">‚Äî</span></span>
      <span>–ü–ª–∞–Ω: <span id="lbl-rev-plan" class="mono">‚Äî</span></span>
    </div>
  </div>

  <div class="card">
    <div class="title">–ü—Ä–µ–º–∏—è –∫ –≤—ã–ø–ª–∞—Ç–µ</div>
    <div class="knum" id="bonus-amount">‚Äî</div>
    <div class="mut" id="bonus-info">–†–∞—Å—á–µ—Ç –ø–æ —Ñ–æ—Ä–º—É–ª–µ: 3% √ó –í—ã—Ä—É—á–∫–∞ √ó ramp √ó Quality</div>
    <div id="bonus-elig" class="pill" style="margin-top: 12px;">‚Äî</div>
  </div>

  <div class="section-title">–î–µ–π—Å—Ç–≤–∏—è</div>
  
  <button class="tg-button" onclick="switchBranch()">üîÑ –°–º–µ–Ω–∏—Ç—å —Ñ–∏–ª–∏–∞–ª</button>
  <button class="tg-button" onclick="exportData()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
  <button class="tg-button" onclick="showHelp()">‚ùì –ü–æ–º–æ—â—å</button>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    const tg = window.Telegram.WebApp;
    
    // –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –≤–∞—à–µ–º—É –æ—Ä–∏–≥–∏–Ω–∞–ª—É)
    const DATA = {
      "month": "2025-09",
      "branches": [
        {
          "branch": "–¢–∏—Ö–∞—è",
          "month": "2025-09",
          "revenue_plan": 3400000,
          "revenue_fact": 3550000,
          "avg_check": 610,
          "guests": 5400,
          "delivery_share": 0.41,
          "fot_amount": 680000,
          "reviews_rating_avg": 4.4,
          "reviews_count_neg": 5,
          "late_count": 4,
          "auditor_score": 88,
          "mystery_score": 85,
          "control_purchase_score": 83,
          "notes": "–†–æ—Å—Ç –≥–æ—Å—Ç–µ–π –∑–∞ —Å—á—ë—Ç –∞–∫—Ü–∏–∏ –ø–æ –ª–∞–ø—à–µ."
        },
        {
          "branch": "–¢–æ–±–æ–ª—å—Å–∫–∞—è", 
          "month": "2025-09",
          "revenue_plan": 3500000,
          "revenue_fact": 3290000,
          "avg_check": 590,
          "guests": 5020,
          "delivery_share": 0.44,
          "fot_amount": 670000,
          "reviews_rating_avg": 4.1,
          "reviews_count_neg": 12,
          "late_count": 9,
          "auditor_score": 79,
          "mystery_score": 74,
          "control_purchase_score": 76,
          "notes": "–ü–µ—Ä–µ—Å–æ–ª –Ω–∞ ¬´–ó–µ–ª—ë–Ω–æ–π –ª–∞–ø—à–µ¬ª. –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –æ–ø–æ–∑–¥–∞–Ω–∏–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∞."
        }
      ]
    };

    let currentBranchIndex = 0;
    const fmt = new Intl.NumberFormat('ru-RU');
    const rub = n => isFinite(n) ? fmt.format(Math.round(n)) + ' ‚ÇΩ' : '‚Äî';
    const pct = x => isFinite(x) ? (Math.round(x * 1000) / 10) + '%' : '‚Äî';

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    function init() {
      tg.ready();
      tg.expand();
      tg.MainButton.setText("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç").hide();
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º Back button –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      if (tg.platform !== 'tdesktop') {
        tg.BackButton.show();
        tg.BackButton.onClick(() => {
          // –õ–æ–≥–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞
        });
      }
      
      render();
    }

    function curr() {
      return DATA.branches[currentBranchIndex];
    }

    function compute(b) {
      const base = (+b.revenue_fact || 0) * 0.03;
      const plan = +b.revenue_plan || 0;
      const fact = +b.revenue_fact || 0;
      const fulfill = plan ? fact / plan : 0;
      
      // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ä–∞–º–ø—ã
      let ramp = 0;
      if (fulfill >= 1.0) ramp = 1.0;
      else if (fulfill >= 0.95) ramp = (fulfill - 0.95) / 0.05;
      
      // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π Quality score
      const quality = (
        (b.auditor_score / 100) * 0.35 +
        (b.control_purchase_score / 100) * 0.30 + 
        (b.mystery_score / 100) * 0.20 +
        Math.max(0, Math.min(1, (b.reviews_rating_avg - 3.5) / 1.5)) * 0.15
      );
      
      const payout = base * ramp * quality;
      return { base, ramp, quality, payout, fulfill };
    }

    function render() {
      const b = curr();
      const g = $('#kpi-grid');
      g.innerHTML = '';

      const cards = [
        { t: "–°—Ä–µ–¥–Ω–∏–π —á–µ–∫", v: fmt.format(b.avg_check) + ' ‚ÇΩ', s: `–ì–æ—Å—Ç–µ–π: ${fmt.format(b.guests)}` },
        { t: "–§–û–¢", v: rub(b.fot_amount), s: `–î–æ–ª—è: ${Math.round((b.fot_amount / b.revenue_fact) * 1000) / 10}%` },
        { t: "–û—Ç–∑—ã–≤—ã", v: b.reviews_rating_avg + " ‚òÖ", s: `–ù–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö: ${b.reviews_count_neg}` },
        { t: "–ê—É–¥–∏—Ç", v: b.auditor_score + "/100", s: `–ö–æ–Ω—Ç—Ä–æ–ª—å: ${b.control_purchase_score}/100` },
        { t: "–¢–∞–π–Ω—ã–π –≥–æ—Å—Ç—å", v: b.mystery_score + "/100", s: "" },
        { t: "–î–æ—Å—Ç–∞–≤–∫–∞", v: pct(b.delivery_share), s: "" }
      ];

      cards.forEach(c => {
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <div class="title">${c.t}</div>
          <div class="knum">${c.v}</div>
          <div class="mut">${c.s}</div>
        `;
        g.appendChild(el);
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
      const r = compute(b);
      const plan = +b.revenue_plan || 0, fact = +b.revenue_fact || 0;
      
      $('#kpi-fulfill-label').textContent = pct(r.fulfill);
      $('#lbl-rev-fact').textContent = rub(fact);
      $('#lbl-rev-plan').textContent = rub(plan);
      $('#bar-fulfill').style.width = Math.min(r.fulfill * 100, 150) + '%';
      
      $('#bonus-amount').textContent = rub(r.payout);
      const elig = $('#bonus-elig');
      elig.textContent = r.ramp === 0 ? '–ù–µ–¥–æ–ø—É—Å–∫' : (r.ramp < 1 ? '–ß–∞—Å—Ç–∏—á–Ω—ã–π –¥–æ–ø—É—Å–∫' : '–ü–æ–ª–Ω—ã–π –¥–æ–ø—É—Å–∫');
      elig.className = 'pill ' + (r.ramp === 0 ? 'bad' : (r.ramp < 1 ? 'warn' : 'good'));
    }

    function switchBranch() {
      currentBranchIndex = (currentBranchIndex + 1) % DATA.branches.length;
      render();
      tg.showPopup({
        title: "–§–∏–ª–∏–∞–ª –∏–∑–º–µ–Ω–µ–Ω",
        message: `–¢–µ–ø–µ—Ä—å: ${curr().branch}`
      });
    }

    function exportData() {
      const b = curr();
      const data = `
–§–∏–ª–∏–∞–ª: ${b.branch}
–í—ã—Ä—É—á–∫–∞: ${rub(b.revenue_fact)}
–ü–ª–∞–Ω: ${rub(b.revenue_plan)} 
–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: ${pct(b.revenue_fact / b.revenue_plan)}
–ü—Ä–µ–º–∏—è: ${$('#bonus-amount').textContent}
      `.trim();
      
      tg.showPopup({
        title: "–î–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞",
        message: data,
        buttons: [{ type: "ok" }]
      });
    }

    function showHelp() {
      tg.showPopup({
        title: "–ü–æ–º–æ—â—å",
        message: "–≠—Ç–æ –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ß–∏-–§–∞–Ω—å –¥–ª—è Telegram. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.",
        buttons: [{ type: "ok" }]
      });
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    const $ = s => document.querySelector(s);

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    init();
  </script>
</body>
</html>