<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∏-–§–∞–Ω—å ‚Äî –í—ã—Ä—É—á–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #4285F4;
            --success-color: #4285F4;
            --warning-color: #F4B400;
            --danger-color: #E53935;
            --bg-color: #0d1117;
            --card-bg: #1a202c;
            --text-primary: #e6f1ff;
            --text-secondary: #b3c3d2;
            --border-color: #1f2838;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        [data-theme="dark"] {
            --bg-color: #0d1117;
            --card-bg: #1a202c;
            --text-primary: #e6f1ff;
            --text-secondary: #b3c3d2;
            --border-color: #1f2838;
        }
        [data-theme="light"] {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        h1 {
            margin: 0;
            color: var(--primary-color);
            font-weight: 700;
            font-size: 2.5rem;
        }
        .theme-toggle {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .theme-toggle:hover {
            background: #3971db;
            transform: scale(1.1);
        }
        .theme-toggle:active {
            transform: scale(0.95);
        }
        #last-update {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 8px 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        #business-day-info {
            text-align: center;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 15px;
            padding: 8px 15px;
            background: rgba(66, 133, 244, 0.1);
            border-left: 3px solid var(--primary-color);
            border-radius: 8px;
            border: 1px solid rgba(66, 133, 244, 0.1);
            backdrop-filter: blur(10px);
        }
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
            z-index: 10;
            position: relative;
        }
        .export-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            box-shadow: 0 2px 6px rgba(66, 133, 244, 0.3);
            backdrop-filter: blur(5px);
        }
        .export-btn:hover {
            background: #3971db;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(66, 133, 244, 0.4);
        }
        .export-btn:active {
            transform: translateY(0);
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: slideIn 0.5s ease;
            opacity: 0;
            transform: translateY(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
        }
        .metric-card.fade-in {
            opacity: 1;
            transform: translateY(0);
        }
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .metric-icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
            transition: transform 0.3s ease;
        }
        .metric-icon:hover {
            transform: scale(1.2);
        }
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }
        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }
        .progress-container {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 10px;
            font-size: 1rem;
            font-weight: 500;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
        }
        .progress-fill {
            height: 100%;
            transition: width 1s ease;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(90deg, var(--primary-color), #3971db);
        }
        .progress-fill.good { background: linear-gradient(90deg, var(--success-color), #3971db); }
        .progress-fill.warn { background: linear-gradient(90deg, var(--warning-color), #d97706); }
        .progress-fill.bad { background: linear-gradient(90deg, var(--danger-color), #dc2626); }
        .progress-text {
            text-align: center;
            font-weight: 500;
            margin-top: 10px;
            color: var(--text-primary);
        }
        .section {
            margin-bottom: 40px;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }
        .section-title::before {
            content: '';
            position: absolute;
            left: 0;
            bottom: -5px;
            width: 50px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 3px;
        }
        .venues-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .venue-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: box-shadow 0.3s ease, transform 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        .venue-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
            border-color: rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
        }
        .venue-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        .venue-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        .venue-metric-value {
            font-weight: 500;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }
        .chart-container canvas {
            color: var(--text-primary);
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .venues-grid { grid-template-columns: 1fr; }
            body { padding: 10px; }
            .metric-card {
                margin-bottom: 10px;
            }
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
            backdrop-filter: blur(5px);
        }
        .toast.show {
            opacity: 1;
        }
        .error-msg {
            color: var(--danger-color);
            text-align: center;
            padding: 10px;
            background: rgba(229, 57, 53, 0.1);
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid rgba(229, 57, 53, 0.2);
            backdrop-filter: blur(5px);
        }
        .data-selector {
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .date-range-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        .date-range-selector input, .date-range-selector button {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .date-range-selector button {
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(66, 133, 244, 0.3);
        }
        .date-range-selector button:hover {
            background: #3971db;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(66, 133, 244, 0.4);
        }
        .date-range-selector button:active {
            transform: translateY(0);
        }
        .metric-value.good, .metric-value.warn, .metric-value.bad {
            color: inherit;
        }
        .data-source-info {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 5px;
            font-style: italic;
            transition: color 0.3s ease;
        }
        .quick-periods {
            display: flex;
            gap: 8px;
            margin-left: auto;
            flex-wrap: wrap;
        }
        .period-btn {
            background: var(--warning-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(244, 180, 0, 0.3);
        }
        .period-btn:hover {
            background: #d97706;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(244, 180, 0, 0.4);
        }
        .period-btn.active {
            background: var(--success-color);
            box-shadow: 0 0 0 2px var(--success-color);
            transform: scale(1.05);
        }
        .auto-refresh-info {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: color 0.3s ease;
        }
        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–±–∏–≤–∫–∏ –∑–∞–∫–∞–∑–æ–≤ */
        .orders-breakdown {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
        }
        .order-type {
            text-align: center;
            padding: 8px;
            background: rgba(66, 133, 244, 0.1);
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        .order-type.delivery { background: rgba(16, 185, 129, 0.1); }
        .order-type.pickup { background: rgba(245, 158, 11, 0.1); }
        .order-type.cafe { background: rgba(139, 92, 246, 0.1); }
        .order-type-value {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 2px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        .order-type-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: var(--card-bg);
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
        }
        .close {
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        .close:hover {
            color: var(--text-primary);
            transform: scale(1.2);
        }
        .venue-details-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        .venue-details-btn:hover {
            transform: scale(1.2);
        }
        /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –ø—Ä–∞–∑–¥–Ω–∏–∫–∞ */
        @keyframes celebrate {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .celebrate {
            animation: celebrate 0.5s ease;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö */
        .new-data-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
            cursor: pointer;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        .new-data-notification:hover {
            transform: scale(1.05);
        }
        .new-data-notification:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <header>
            <h1><i class="fas fa-utensils"></i> –ß–∏-–§–∞–Ω—å ‚Äî –í—ã—Ä—É—á–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h1>
            <button class="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
        </header>
        <div id="business-day-info">
            <i class="fas fa-clock"></i> –¢–µ–∫—É—â–∏–π –±–∏–∑–Ω–µ—Å-–¥–µ–Ω—å: <span id="business-day-date"></span>
        </div>
        <div id="last-update"><i class="fas fa-clock"></i> –ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="date-range-selector">
            <label for="start-date">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞:</label>
            <input type="date" id="start-date">
            <label for="end-date">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞:</label>
            <input type="date" id="end-date">
            <button onclick="loadCustomData()"><i class="fas fa-download"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            <div class="quick-periods">
                <button class="period-btn" onclick="setPeriod('today')">–°–µ–≥–æ–¥–Ω—è</button>
                <button class="period-btn" onclick="setPeriod('yesterday')">–í—á–µ—Ä–∞</button>
                <button class="period-btn" onclick="setPeriod('thisWeek')">–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</button>
                <button class="period-btn" onclick="setPeriod('thisMonth')">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</button>
                <button class="period-btn" onclick="setPeriod('lastMonth')">–ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü</button>
            </div>
        </div>
        <div class="metrics-grid" id="metrics"></div>
        <div class="progress-container">
            <h3><i class="fas fa-chart-line"></i> –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –ø–ª–∞–Ω—É</h3>
            <div class="progress-header">
                <span>–¢–µ–∫—É—â–µ–µ: <span id="current-value">0 ‚ÇΩ</span></span>
                <span>–ü–ª–∞–Ω: <span id="plan-value">0 ‚ÇΩ</span></span>
            </div>
            <div class="progress-bar">
                <div id="plan-bar" class="progress-fill"></div>
            </div>
            <div id="progress-text" class="progress-text">0%</div>
        </div>
        <div class="charts-grid">
            <div class="chart-container">
                <h4>–í—ã—Ä—É—á–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h4>
                <canvas id="barChart1"></canvas>
            </div>
            <div class="chart-container">
                <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º</h4>
                <select class="data-selector" id="dataType" onchange="updateBarChart2()">
                    <option value="revenue">–í—ã—Ä—É—á–∫–∞</option>
                    <option value="orders">–ó–∞–∫–∞–∑—ã</option>
                    <option value="delivery">–î–æ—Å—Ç–∞–≤–∫–∞</option>
                    <option value="cafe">–ö–∞—Ñ–µ</option>
                    <option value="pickup">–°–∞–º–æ–≤—ã–≤–æ–∑</option>
                </select>
                <canvas id="barChart2"></canvas>
            </div>
        </div>
        <div class="section">
            <h3 class="section-title"><i class="fas fa-building"></i> –ö—Ä—É–≥–ª–æ–≥–æ–¥–∏—á–Ω—ã–µ —Ñ–∏–ª–∏–∞–ª—ã</h3>
            <div class="venues-grid" id="year-round"></div>
        </div>
        <div class="section">
            <h3 class="section-title"><i class="fas fa-leaf"></i> –°–µ–∑–æ–Ω–Ω—ã–µ —Ñ–∏–ª–∏–∞–ª—ã</h3>
            <div class="venues-grid" id="seasonal"></div>
        </div>
        <div class="export-buttons">
            <button class="export-btn" onclick="exportPDF('all')"><i class="fas fa-file-pdf"></i> –≠–∫—Å–ø–æ—Ä—Ç PDF (–í—Å–µ)</button>
            <button class="export-btn" onclick="exportPDF('year-round')"><i class="fas fa-file-pdf"></i> PDF –ö—Ä—É–≥–ª–æ–≥–æ–¥–∏—á–Ω—ã–µ</button>
            <button class="export-btn" onclick="exportPDF('seasonal')"><i class="fas fa-file-pdf"></i> PDF –°–µ–∑–æ–Ω–Ω—ã–µ</button>
        </div>
        <div id="auto-refresh-info" class="auto-refresh-info">
            <i class="fas fa-sync-alt"></i> –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 4 –º–∏–Ω—É—Ç—ã
        </div>
        <div id="toast" class="toast"></div>
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö -->
        <div id="new-data-notification" class="new-data-notification">
            <i class="fas fa-bell"></i> –î–æ—Å—Ç—É–ø–Ω—ã –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ! <u>–û–±–Ω–æ–≤–∏—Ç—å</u>
        </div>
    </div>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Ñ–∏–ª–∏–∞–ª–∞ -->
    <div id="venueModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modalVenueName"></h3>
            <div id="modalVenueDetails"></div>
        </div>
    </div>
    <script>
        let barChart1, barChart2;
        let dataCache = {};
        let currentStartDate = '';
        let currentEndDate = '';
        let activePeriod = 'today';
        let autoRefreshInterval;
        let lastDataHash = '';
        // --- –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ù–ê–°–¢–†–û–ô–ö–ò ---
        const DAILY_NETWORK_PLAN = 50000;
        const BASE_DATA_URL = 'https://wwwgolybfs-dev.github.io/chifan2025/data/daily/';
        const LATEST_DATA_URL = 'https://wwwgolybfs-dev.github.io/chifan2025/data/revenue.json';
        const fmt = new Intl.NumberFormat('ru-RU');
        const AUTO_REFRESH_INTERVAL = 4 * 60 * 1000; // 4 –º–∏–Ω—É—Ç—ã
        const fixedDailyPlans = {
            "–¢–æ–±–æ–ª—å—Å–∫–∞—è": 70000,
            "–¢–∏—Ö–∞—è": 55000,
            "–ö—Ä–∞—Å–æ—Ç–∞": 80000,
        };
        // --- –£–¢–ò–õ–ò–¢–´ ---
        function getCurrentBusinessDay() {
            const now = new Date();
            // –ï—Å–ª–∏ –≤—Ä–µ–º—è –º–µ–Ω—å—à–µ 03:00, —Ç–µ–∫—É—â–∏–π –±–∏–∑–Ω–µ—Å-–¥–µ–Ω—å - —ç—Ç–æ –≤—á–µ—Ä–∞—à–Ω–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –¥–µ–Ω—å
            if (now.getHours() < 3) {
                return new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
            }
            // –ò–Ω–∞—á–µ —Ç–µ–∫—É—â–∏–π –±–∏–∑–Ω–µ—Å-–¥–µ–Ω—å - —ç—Ç–æ —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞
            return new Date(now.getFullYear(), now.getMonth(), now.getDate());
        }
        function getTodayDateString() {
            return getCurrentBusinessDay().toISOString().split('T')[0];
        }
        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }
        function getWeekStartDate(date = new Date()) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            return d;
        }
        function getMonthStartDate(date = new Date()) {
            return new Date(date.getFullYear(), date.getMonth(), 1);
        }
        function getLastMonthStartDate() {
            const date = new Date();
            return new Date(date.getFullYear(), date.getMonth() - 1, 1);
        }
        function getLastMonthEndDate() {
            const date = new Date();
            return new Date(date.getFullYear(), date.getMonth(), 0);
        }
        function isCurrentBusinessDay(dateStr) {
            const now = new Date();
            const businessDay = new Date(dateStr);
            // –ï—Å–ª–∏ –≤—Ä–µ–º—è –º–µ–Ω—å—à–µ 03:00, —Ç–æ —Ç–µ–∫—É—â–∏–π –±–∏–∑–Ω–µ—Å-–¥–µ–Ω—å - —ç—Ç–æ –≤—á–µ—Ä–∞—à–Ω–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –¥–µ–Ω—å
            if (now.getHours() < 3) {
                return businessDay.toDateString() === (new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1)).toDateString();
            } else {
                return businessDay.toDateString() === (new Date(now.getFullYear(), now.getMonth(), now.getDate())).toDateString();
            }
        }
        function setPeriod(period) {
            const businessDay = getCurrentBusinessDay();
            let startDate, endDate;
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            activePeriod = period;
            switch(period) {
                case 'today':
                    startDate = new Date(businessDay);
                    endDate = new Date(businessDay);
                    break;
                case 'yesterday':
                    const yesterday = new Date(businessDay);
                    yesterday.setDate(yesterday.getDate() - 1);
                    startDate = yesterday;
                    endDate = yesterday;
                    break;
                case 'thisWeek':
                    startDate = getWeekStartDate(new Date(businessDay));
                    endDate = new Date(businessDay);
                    break;
                case 'thisMonth':
                    startDate = getMonthStartDate(new Date(businessDay));
                    endDate = new Date(businessDay);
                    break;
                case 'lastMonth':
                    startDate = getLastMonthStartDate();
                    endDate = getLastMonthEndDate();
                    break;
            }
            document.getElementById('start-date').value = formatDateForInput(startDate);
            document.getElementById('end-date').value = formatDateForInput(endDate);
            loadCustomData();
        }
        function calculateDailyPlanFromMonthly(monthlyPlan, dateStr, isRevenue = true) {
            if (!monthlyPlan || monthlyPlan === 0) {
                return isRevenue ? DAILY_NETWORK_PLAN : 1000;
            }
            try {
                const date = new Date(dateStr);
                const year = date.getFullYear();
                const month = date.getMonth();
                // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü–µ
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–∏–π –¥–Ω–µ–≤–Ω–æ–π –ø–ª–∞–Ω
                const dailyPlan = monthlyPlan / daysInMonth;
                return isRevenue ? dailyPlan : Math.round(dailyPlan);
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –¥–Ω–µ–≤–Ω–æ–≥–æ –ø–ª–∞–Ω–∞:', e);
                return isRevenue ? DAILY_NETWORK_PLAN : 1000;
            }
        }
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const icon = document.querySelector('.theme-toggle i');
            icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            updateChartTheme();
        }
        function updateChartTheme() {
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
            const updateOptions = { 
                scales: { 
                    x: { title: { color: textColor }, ticks: { color: textColor } }, 
                    y: { title: { color: textColor }, ticks: { color: textColor } } 
                }, 
                plugins: { legend: { labels: { color: textColor } } } 
            };
            if (barChart1) {
                Object.assign(barChart1.options.scales, updateOptions.scales);
                barChart1.options.plugins.legend.labels.color = textColor;
                barChart1.update();
            }
            if (barChart2) {
                Object.assign(barChart2.options.scales, updateOptions.scales);
                barChart2.options.plugins.legend.labels.color = textColor;
                barChart2.update();
            }
        }
        function getStatusClass(fulfill) {
            if (fulfill >= 100) return 'good';
            if (fulfill >= 80) return 'warn';
            return 'bad';
        }
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.style.background = type === 'error' ? 'var(--danger-color)' : 'var(--success-color)';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        function getDiffDays(startDateStr, endDateStr) {
            const start = new Date(startDateStr);
            const end = new Date(endDateStr);
            if (isNaN(start) || isNaN(end)) return 1;
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        }
        // --- –õ–û–ì–ò–ö–ê –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–• ---
        async function fetchDataForDate(dateStr) {
            const todayStr = getTodayDateString();
            const isToday = dateStr === todayStr;
            // –î–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã –ø—Ä–æ–±—É–µ–º —Å–Ω–∞—á–∞–ª–∞ latest, –ø–æ—Ç–æ–º daily
            const urls = [];
            if (isToday) {
                urls.push(LATEST_DATA_URL + '?t=' + Date.now()); // latest - —Å–Ω–∞—á–∞–ª–∞ —Å timestamp
                urls.push(`${BASE_DATA_URL}${dateStr}_revenue.json?t=${Date.now()}`); // daily –∞—Ä—Ö–∏–≤
            } else {
                urls.push(`${BASE_DATA_URL}${dateStr}_revenue.json?t=${Date.now()}`); // —Ç–æ–ª—å–∫–æ daily
            }
            for (const url of urls) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        // –î–ª—è latest –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞—Ç—É
                        if (url.includes('revenue.json') && !url.includes('daily')) {
                            if (data.date && data.date !== dateStr) {
                                console.warn(`Latest –¥–∞–Ω–Ω—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –¥—Ä—É–≥—É—é –¥–∞—Ç—É (${data.date}), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);
                                continue;
                            }
                        }
                        let calculatedRevenue = 0;
                        let calculatedOrders = 0;
                        let calculatedDeliveryOrders = 0;
                        let calculatedPickupOrders = 0;
                        let calculatedCafeOrders = 0;
                        const allVenues = { ...data.year_round, ...data.seasonal };
                        Object.values(allVenues).forEach(stats => {
                            calculatedRevenue += stats.total_revenue || 0;
                            calculatedOrders += stats.total_orders || 0;
                            calculatedDeliveryOrders += stats.delivery_orders || 0;
                            calculatedPickupOrders += stats.pickup_orders || 0;
                            calculatedCafeOrders += stats.cafe_orders || 0;
                        });
                        const planRevenue = data.plan?.total_revenue || DAILY_NETWORK_PLAN;
                        const planOrders = data.plan?.total_orders || 1000;
                        const result = {
                            ...data,
                            plan: { total_revenue: planRevenue, total_orders: planOrders },
                            total: {
                                total_revenue: calculatedRevenue,
                                total_orders: calculatedOrders,
                                total_delivery_orders: calculatedDeliveryOrders,
                                total_pickup_orders: calculatedPickupOrders,
                                total_cafe_orders: calculatedCafeOrders
                            },
                            _source: url.includes('revenue.json') && !url.includes('daily') ? 'latest' : 'daily'
                        };
                        dataCache[dateStr] = result;
                        return result;
                    }
                } catch (error) {
                    console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ ${url}: ${error.message}`);
                }
            }
            console.warn(`–§–∞–π–ª –¥–ª—è ${dateStr} –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ`);
            return {
                date: dateStr, time: "00:00", year_round: {}, seasonal: {}, 
                plan: { total_revenue: DAILY_NETWORK_PLAN, total_orders: 1000 },
                total: { 
                    total_revenue: 0, 
                    total_orders: 0,
                    total_delivery_orders: 0,
                    total_pickup_orders: 0,
                    total_cafe_orders: 0
                },
                _source: 'empty'
            };
        }
        async function loadData(startDateStr, endDateStr) {
            const diffDays = getDiffDays(startDateStr, endDateStr);
            let combinedData = {
                year_round: {}, seasonal: {}, 
                total: { 
                    total_revenue: 0, 
                    total_orders: 0,
                    total_delivery_orders: 0,
                    total_pickup_orders: 0,
                    total_cafe_orders: 0
                },
                date: `${startDateStr} - ${endDateStr}`,
                time: "23:59",
                _sources: new Set()
            };
            const dateList = [];
            let currentDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            if (isNaN(currentDate) || isNaN(endDate) || currentDate > endDate) {
                // –î–ª—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞—Ç –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–Ω–µ–≤–Ω–æ–π –ø–ª–∞–Ω
                combinedData.plan = { total_revenue: DAILY_NETWORK_PLAN * diffDays, total_orders: 1000 * diffDays };
                return combinedData;
            }
            while (currentDate <= endDate) {
                dateList.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            let totalDailyPlanRevenue = 0;
            let totalDailyPlanOrders = 0;
            let totalActualRevenue = 0;
            let totalActualOrders = 0;
            let totalActualDeliveryOrders = 0;
            let totalActualPickupOrders = 0;
            let totalActualCafeOrders = 0;
            const promises = dateList.map(dateStr => fetchDataForDate(dateStr));
            const dailyResults = await Promise.all(promises);
            dailyResults.forEach(dailyData => {
                totalActualRevenue += dailyData.total.total_revenue || 0;
                totalActualOrders += dailyData.total.total_orders || 0;
                totalActualDeliveryOrders += dailyData.total.total_delivery_orders || 0;
                totalActualPickupOrders += dailyData.total.total_pickup_orders || 0;
                totalActualCafeOrders += dailyData.total.total_cafe_orders || 0;
                combinedData._sources.add(dailyData._source);
                const venuesToCombine = { ...dailyData.year_round, ...dailyData.seasonal };
                for (const venue in venuesToCombine) {
                    const stats = venuesToCombine[venue];
                    let existingStats = combinedData.year_round[venue] || combinedData.seasonal[venue];
                    if (!existingStats) {
                        const target = dailyData.year_round[venue] ? combinedData.year_round : combinedData.seasonal;
                        target[venue] = { ...stats };
                    } else {
                        for (const key in stats) {
                            if (typeof stats[key] === 'number') {
                                existingStats[key] = (existingStats[key] || 0) + (stats[key] || 0);
                            }
                        }
                    }
                }
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–Ω–µ–≤–Ω–æ–π –ø–ª–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Å—è—á–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö
                const dailyPlanRevenue = calculateDailyPlanFromMonthly(dailyData.plan?.total_revenue, dailyData.date);
                const dailyPlanOrders = calculateDailyPlanFromMonthly(dailyData.plan?.total_orders, dailyData.date, false);
                totalDailyPlanRevenue += dailyPlanRevenue;
                totalDailyPlanOrders += dailyPlanOrders;
            });
            combinedData.total = {
                total_revenue: totalActualRevenue,
                total_orders: totalActualOrders,
                total_delivery_orders: totalActualDeliveryOrders,
                total_pickup_orders: totalActualPickupOrders,
                total_cafe_orders: totalActualCafeOrders
            };
            combinedData.plan = {
                total_revenue: totalDailyPlanRevenue,
                total_orders: totalDailyPlanOrders
            };
            if (diffDays === 1 && dailyResults[0].time !== "00:00") {
                combinedData.time = dailyResults[0].time;
            }
            return combinedData;
        }
        // --- –†–ï–ù–î–ï–†–ò–ù–ì ---
        function renderMetrics(data) {
            const total = data.total || { 
                total_revenue: 0, 
                total_orders: 0,
                total_delivery_orders: 0,
                total_pickup_orders: 0,
                total_cafe_orders: 0
            };
            const plan = data.plan || { total_revenue: DAILY_NETWORK_PLAN, total_orders: 1000 };
            const avg_bill = total.total_orders > 0 ? total.total_revenue / total.total_orders : 0;
            const revenueFulfill = plan.total_revenue > 0 ? (total.total_revenue / plan.total_revenue) * 100 : 0;
            let sourceInfo = '';
            if (data._sources) {
                const sources = Array.from(data._sources);
                if (sources.includes('latest')) {
                    sourceInfo = '<div class="data-source-info">üìä –î–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (–∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)</div>';
                } else if (sources.includes('daily')) {
                    sourceInfo = '<div class="data-source-info">üìÅ –ê—Ä—Ö–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>';
                }
            }
            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞–Ω–µ
            const debugInfo = `<div class="data-source-info">üìà –ü–ª–∞–Ω —Ä–∞—Å—á–∏—Ç–∞–Ω –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞: ${fmt.format(plan.total_revenue.toFixed(0))} ‚ÇΩ</div>`;
            document.getElementById('metrics').innerHTML = `
                <div class="metric-card fade-in">
                    <div class="metric-icon"><i class="fas fa-ruble-sign"></i></div>
                    <div class="metric-value">${fmt.format(total.total_revenue.toFixed(0))} ‚ÇΩ</div>
                    <div class="metric-label">–í—ã—Ä—É—á–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
                    ${sourceInfo}
                    ${debugInfo}
                </div>
                <div class="metric-card fade-in">
                    <div class="metric-icon"><i class="fas fa-shopping-cart"></i></div>
                    <div class="metric-value">${total.total_orders}</div>
                    <div class="metric-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                    <div class="orders-breakdown">
                        <div class="order-type delivery">
                            <div class="order-type-value">${total.total_delivery_orders || 0}</div>
                            <div class="order-type-label">–î–æ—Å—Ç–∞–≤–∫–∞</div>
                        </div>
                        <div class="order-type pickup">
                            <div class="order-type-value">${total.total_pickup_orders || 0}</div>
                            <div class="order-type-label">–°–∞–º–æ–≤—ã–≤–æ–∑</div>
                        </div>
                        <div class="order-type cafe">
                            <div class="order-type-value">${total.total_cafe_orders || 0}</div>
                            <div class="order-type-label">–ö–∞—Ñ–µ</div>
                        </div>
                    </div>
                </div>
                <div class="metric-card fade-in">
                    <div class="metric-icon"><i class="fas fa-receipt"></i></div>
                    <div class="metric-value">${fmt.format(avg_bill.toFixed(0))} ‚ÇΩ</div>
                    <div class="metric-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
                </div>
                <div class="metric-card fade-in">
                    <div class="metric-icon"><i class="fas fa-percent"></i></div>
                    <div class="metric-value ${getStatusClass(revenueFulfill)}">${revenueFulfill.toFixed(1)}%</div>
                    <div class="metric-label">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ (–í—ã—Ä—É—á–∫–∞)</div>
                </div>
            `;
            const bar = document.getElementById('plan-bar');
            const progressText = document.getElementById('progress-text');
            const currentValue = document.getElementById('current-value');
            const planValue = document.getElementById('plan-value');
            if (bar && progressText && currentValue && planValue) {
                bar.className = `progress-fill ${getStatusClass(revenueFulfill)}`;
                bar.style.width = Math.min(revenueFulfill, 100) + '%';
                progressText.textContent = `${revenueFulfill.toFixed(1)}%`;
                currentValue.textContent = `${fmt.format(total.total_revenue.toFixed(0))} ‚ÇΩ`;
                planValue.textContent = `${fmt.format(plan.total_revenue.toFixed(0))} ‚ÇΩ`;
            }
            if (revenueFulfill > 100) {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä–∞–∑–¥–Ω–∏–∫–∞ –∫ –∫–∞—Ä—Ç–æ—á–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞
                const planCard = document.querySelector('.metric-card:last-child');
                if (planCard) {
                    planCard.classList.add('celebrate');
                    setTimeout(() => planCard.classList.remove('celebrate'), 1000);
                }
            }
        }
        function renderVenueCard(venue, stats, periodDays) {
            const dailyPlan = fixedDailyPlans[venue] || DAILY_NETWORK_PLAN;
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–ª–∞–Ω –¥–ª—è –≤—Å–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
            const planRevenueForPeriod = dailyPlan * periodDays;
            const fulfill = planRevenueForPeriod > 0 ? (stats.total_revenue || 0) / planRevenueForPeriod * 100 : 0;
            const statusClass = getStatusClass(fulfill);
            return `
                <div class="venue-card fade-in">
                    <button class="venue-details-btn" onclick="openVenueModal('${venue}', ${JSON.stringify(stats).replace(/'/g, "&#39;")}, ${periodDays})">
                        <i class="fas fa-chart-bar"></i>
                    </button>
                    <div class="venue-name">${venue}</div>
                    <div class="venue-metric"><span>–í—ã—Ä—É—á–∫–∞:</span> <span class="venue-metric-value ${statusClass}">${fmt.format((stats.total_revenue || 0).toFixed(0))} ‚ÇΩ</span></div>
                    <div class="venue-metric"><span>–ó–∞–∫–∞–∑—ã:</span> <span>${stats.total_orders || 0}</span></div>
                    <div class="venue-metric"><span>–î–æ—Å—Ç–∞–≤–∫–∞:</span> <span>${fmt.format((stats.delivery_revenue || 0).toFixed(0))} ‚ÇΩ</span></div>
                    <div class="venue-metric"><span>–ö–∞—Ñ–µ:</span> <span>${fmt.format((stats.cafe_revenue || 0).toFixed(0))} ‚ÇΩ</span></div>
                    <div class="venue-metric"><span>–°–∞–º–æ–≤—ã–≤–æ–∑:</span> <span>${fmt.format((stats.pickup_revenue || 0).toFixed(0))} ‚ÇΩ</span></div>
                    <div class="orders-breakdown" style="margin-top: 10px;">
                        <div class="order-type delivery">
                            <div class="order-type-value">${stats.delivery_orders || 0}</div>
                            <div class="order-type-label">–î–æ—Å—Ç–∞–≤–∫–∞</div>
                        </div>
                        <div class="order-type pickup">
                            <div class="order-type-value">${stats.pickup_orders || 0}</div>
                            <div class="order-type-label">–°–∞–º–æ–≤—ã–≤–æ–∑</div>
                        </div>
                        <div class="order-type cafe">
                            <div class="order-type-value">${stats.cafe_orders || 0}</div>
                            <div class="order-type-label">–ö–∞—Ñ–µ</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <div class="progress-bar" style="height: 8px;">
                            <div class="progress-fill ${statusClass}" style="width: ${Math.min(fulfill, 100)}%;"></div>
                        </div>
                        <small>${fulfill.toFixed(1)}% –æ—Ç –ø–ª–∞–Ω–∞ (${fmt.format(planRevenueForPeriod.toFixed(0))} ‚ÇΩ)</small>
                    </div>
                </div>
            `;
        }
        function renderVenues(data, containerId) {
            const key = containerId === 'year-round' ? 'year_round' : 'seasonal';
            const venues = data[key] || {};
            const container = document.getElementById(containerId);
            if (!container) return;
            if (Object.keys(venues).length === 0) {
                container.innerHTML = '<div class="error-msg">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</div>';
                return;
            }
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –ø–µ—Ä–∏–æ–¥–µ
            const periodDays = getDiffDays(currentStartDate, currentEndDate);
            const sortedVenues = Object.entries(venues).sort((a, b) => (b[1].total_revenue || 0) - (a[1].total_revenue || 0));
            container.innerHTML = sortedVenues.map(([venue, stats]) => renderVenueCard(venue, stats, periodDays)).join('');
        }
        // --- –§–£–ù–ö–¶–ò–ò –ì–†–ê–§–ò–ö–û–í ---
        function renderCharts(data) {
            const allVenues = { ...data.year_round, ...data.seasonal };
            const labels = Object.keys(allVenues).length > 0 ? Object.keys(allVenues) : ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'];
            const revenues = labels.map(l => allVenues[l]?.total_revenue || 0);
            const ctxBar1 = document.getElementById('barChart1')?.getContext('2d');
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
            if (ctxBar1) {
                if (barChart1) barChart1.destroy();
                barChart1 = new Chart(ctxBar1, {
                    type: 'bar',
                    data: { 
                        labels, 
                        datasets: [{ 
                            label: '–í—ã—Ä—É—á–∫–∞ ‚ÇΩ', 
                            data: revenues, 
                            backgroundColor: ['#4285F4', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316'] 
                        }] 
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { title: { display: true, text: '–§–∏–ª–∏–∞–ª—ã', color: textColor }, ticks: { color: textColor } },
                            y: { beginAtZero: true, title: { display: true, text: '–í—ã—Ä—É—á–∫–∞ ‚ÇΩ', color: textColor }, ticks: { color: textColor } }
                        },
                        plugins: { legend: { position: 'bottom', labels: { color: textColor } } }
                    }
                });
            }
            updateBarChart2(data);
        }
        function updateBarChart2(data) {
            const dataType = document.getElementById('dataType').value;
            const allVenues = data ? { ...data.year_round, ...data.seasonal } : {};
            const labels = Object.keys(allVenues).length > 0 ? Object.keys(allVenues) : ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'];
            const ctxBar2 = document.getElementById('barChart2')?.getContext('2d');
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
            let dataValues;
            switch(dataType) {
                case 'orders':
                    dataValues = labels.map(l => allVenues[l]?.total_orders || 0);
                    break;
                case 'delivery':
                    dataValues = labels.map(l => allVenues[l]?.delivery_revenue || 0);
                    break;
                case 'cafe':
                    dataValues = labels.map(l => allVenues[l]?.cafe_revenue || 0);
                    break;
                case 'pickup':
                    dataValues = labels.map(l => allVenues[l]?.pickup_revenue || 0);
                    break;
                default: // revenue
                    dataValues = labels.map(l => allVenues[l]?.total_revenue || 0);
            }
            if (ctxBar2) {
                if (barChart2) barChart2.destroy();
                barChart2 = new Chart(ctxBar2, {
                    type: 'bar',
                    data: { 
                        labels, 
                        datasets: [{ 
                            label: `${dataType === 'orders' ? '–ó–∞–∫–∞–∑—ã' : '–í—ã—Ä—É—á–∫–∞ ‚ÇΩ'}`, 
                            data: dataValues, 
                            backgroundColor: ['#4285F4', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316'] 
                        }] 
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { title: { display: true, text: '–§–∏–ª–∏–∞–ª—ã', color: textColor }, ticks: { color: textColor } },
                            y: { beginAtZero: true, title: { display: true, text: dataType === 'orders' ? '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤' : '–í—ã—Ä—É—á–∫–∞ ‚ÇΩ', color: textColor }, ticks: { color: textColor } }
                        },
                        plugins: { legend: { position: 'bottom', labels: { color: textColor } } }
                    }
                });
            }
        }
        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–ì–†–£–ó–ö–û–ô ---
        function loadCustomData() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            if (!startDate || !endDate) {
                showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É', 'error');
                return;
            }
            if (new Date(startDate) > new Date(endDate)) {
                showToast('–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ –∫–æ–Ω–µ—á–Ω–æ–π', 'error');
                return;
            }
            const periodText = (startDate === endDate) ? 
                `–∑–∞ –¥–µ–Ω—å ${new Date(startDate).toLocaleDateString('ru-RU')}` : 
                `–∑–∞ –ø–µ—Ä–∏–æ–¥ —Å ${new Date(startDate).toLocaleDateString('ru-RU')} –ø–æ ${new Date(endDate).toLocaleDateString('ru-RU')}`;
            showToast(`–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ${periodText}`);
            load(startDate, endDate);
        }
        async function load(startDateStr, endDateStr) {
            const updateEl = document.getElementById('last-update');
            if (updateEl) updateEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...';
            currentStartDate = startDateStr;
            currentEndDate = endDateStr;
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–∞–µ–º –∫—ç—à –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã, —á—Ç–æ–±—ã –≤—Å–µ–≥–¥–∞ –±—Ä–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const todayStr = getTodayDateString();
            if (isCurrentBusinessDay(startDateStr) || isCurrentBusinessDay(endDateStr)) {
                delete dataCache[todayStr];
            }
            try {
                const data = await loadData(startDateStr, endDateStr); 
                dataCache.current = data;
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                const currentDataHash = JSON.stringify(data.total);
                if (lastDataHash && lastDataHash !== currentDataHash) {
                    showNewDataNotification();
                }
                lastDataHash = currentDataHash;
                let dateDisplay;
                if (startDateStr && endDateStr) {
                    dateDisplay = (startDateStr === endDateStr) ? 
                        new Date(startDateStr).toLocaleDateString('ru-RU') : 
                        `${new Date(startDateStr).toLocaleDateString('ru-RU')} - ${new Date(endDateStr).toLocaleDateString('ru-RU')}`;
                } else {
                    dateDisplay = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                }
                if (updateEl) updateEl.innerHTML = `<i class="fas fa-check-circle"></i> –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${data.time} (${dateDisplay})`;
                renderMetrics(data);
                renderVenues(data, 'year-round');
                renderVenues(data, 'seasonal');
                renderCharts(data); 
                updateChartTheme();
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
                if (updateEl) updateEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                document.getElementById('metrics').innerHTML = '<div class="error-msg">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç—Ä–∏–∫</div>';
                document.getElementById('year-round').innerHTML = '<div class="error-msg">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤</div>';
                document.getElementById('seasonal').innerHTML = '<div class="error-msg">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤</div>';
                showToast('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
            } finally {
                document.querySelectorAll('.metric-card, .venue-card').forEach((el, index) => {
                    setTimeout(() => el.classList.add('fade-in'), index * 50);
                });
            }
        }
        // --- –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–ï ---
        function setupAutoRefresh() {
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 4 –º–∏–Ω—É—Ç—ã
            autoRefreshInterval = setInterval(() => {
                const businessDay = getCurrentBusinessDay();
                const todayStr = businessDay.toISOString().split('T')[0];
                // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –±–∏–∑–Ω–µ—Å-–¥–µ–Ω—å
                if (currentStartDate === todayStr && currentEndDate === todayStr) {
                    console.log('–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');
                    delete dataCache[todayStr]; // –û—á–∏—â–∞–µ–º –∫—ç—à
                    load(currentStartDate, currentEndDate);
                    showToast('–î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                }
            }, AUTO_REFRESH_INTERVAL);
        }
        // --- –ù–û–í–´–ï –§–ò–ß–ò ---
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ —Ñ–∏–ª–∏–∞–ª–∞
        function openVenueModal(venue, stats, periodDays) {
            const modal = document.getElementById('venueModal');
            const modalVenueName = document.getElementById('modalVenueName');
            const modalVenueDetails = document.getElementById('modalVenueDetails');
            const dailyPlan = fixedDailyPlans[venue] || DAILY_NETWORK_PLAN;
            const planRevenueForPeriod = dailyPlan * periodDays;
            const fulfill = planRevenueForPeriod > 0 ? (stats.total_revenue || 0) / planRevenueForPeriod * 100 : 0;
            modalVenueName.textContent = venue;
            modalVenueDetails.innerHTML = `
                <div class="venue-metric"><span>–í—ã—Ä—É—á–∫–∞:</span> <span>${fmt.format((stats.total_revenue || 0).toFixed(0))} ‚ÇΩ</span></div>
                <div class="venue-metric"><span>–ó–∞–∫–∞–∑—ã:</span> <span>${stats.total_orders || 0}</span></div>
                <div class="venue-metric"><span>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞:</span> <span>${fulfill.toFixed(1)}%</span></div>
                <h4 style="margin-top: 15px;">–í—ã—Ä—É—á–∫–∞ –ø–æ —Ç–∏–ø–∞–º:</h4>
                <div class="venue-metric"><span>–î–æ—Å—Ç–∞–≤–∫–∞:</span> <span>${fmt.format((stats.delivery_revenue || 0).toFixed(0))} ‚ÇΩ</span></div>
                <div class="venue-metric"><span>–ö–∞—Ñ–µ:</span> <span>${fmt.format((stats.cafe_revenue || 0).toFixed(0))} ‚ÇΩ</span></div>
                <div class="venue-metric"><span>–°–∞–º–æ–≤—ã–≤–æ–∑:</span> <span>${fmt.format((stats.pickup_revenue || 0).toFixed(0))} ‚ÇΩ</span></div>
                <h4 style="margin-top: 15px;">–ó–∞–∫–∞–∑—ã –ø–æ —Ç–∏–ø–∞–º:</h4>
                <div class="venue-metric"><span>–î–æ—Å—Ç–∞–≤–∫–∞:</span> <span>${stats.delivery_orders || 0}</span></div>
                <div class="venue-metric"><span>–ö–∞—Ñ–µ:</span> <span>${stats.cafe_orders || 0}</span></div>
                <div class="venue-metric"><span>–°–∞–º–æ–≤—ã–≤–æ–∑:</span> <span>${stats.pickup_orders || 0}</span></div>
                <div style="margin-top: 15px; padding: 10px; background: rgba(66, 133, 244, 0.1); border-radius: 8px;">
                    <strong>–ü–ª–∞–Ω:</strong> ${fmt.format(planRevenueForPeriod.toFixed(0))} ‚ÇΩ
                </div>
            `;
            modal.style.display = 'block';
        }
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function showNewDataNotification() {
            const notification = document.getElementById('new-data-notification');
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.querySelector('.close').addEventListener('click', function() {
            document.getElementById('venueModal').style.display = 'none';
        });
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('venueModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        document.getElementById('new-data-notification').addEventListener('click', function() {
            load(currentStartDate, currentEndDate);
            this.style.display = 'none';
        });
        // --- PDF Export ---
        function exportPDF(filter = 'all') {
            const data = dataCache.current;
            if (!data || !data.date) {
                showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            function escapeText(text) {
                return text.replace(/[–∞-—è–ê-–Ø—ë–Å]/g, (char) => {
                    const translitMap = { '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'e', '—ë': 'yo', '–∂': 'zh', '–∑': 'z', '–∏': 'i', '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm', '–Ω': 'n', '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u', '—Ñ': 'f', '—Ö': 'kh', '—Ü': 'ts', '—á': 'ch', '—à': 'sh', '—â': 'sch', '—ä': '"', '—ã': 'y', '—å': "'", '—ç': 'e', '—é': 'yu', '—è': 'ya', '–ê': 'A', '–ë': 'B', '–í': 'V', '–ì': 'G', '–î': 'D', '–ï': 'E', '–Å': 'Yo', '–ñ': 'Zh', '–ó': 'Z', '–ò': 'I', '–ô': 'Y', '–ö': 'K', '–õ': 'L', '–ú': 'M', '–ù': 'N', '–û': 'O', '–ü': 'P', '–†': 'R', '–°': 'S', '–¢': 'T', '–£': 'U', '–§': 'F', '–•': 'Kh', '–¶': 'Ts', '–ß': 'Ch', '–®': 'Sh', '–©': 'Sch', '–™': '"', '–´': 'Y', '–¨': "'", '–≠': 'E', '–Æ': 'Yu', '–Ø': 'Ya' };
                    return translitMap[char] || char;
                });
            }
            doc.setFont("helvetica");
            doc.setFontSize(14);
            doc.text(escapeText('–ß–∏-–§–∞–Ω—å –û—Ç—á–µ—Ç –ø–æ –í—ã—Ä—É—á–∫–µ'), 10, 10);
            doc.setFontSize(10);
            const dateText = `–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞: ${data.date} ${data.time || ''}`;
            doc.text(dateText, 10, 15);
            let y = 25;
            const venues = filter === 'year-round' ? data.year_round : filter === 'seasonal' ? data.seasonal : { ...data.year_round, ...data.seasonal };
            const sortedVenues = Object.entries(venues || {}).sort((a, b) => (b[1].total_revenue || 0) - (a[1].total_revenue || 0));
            sortedVenues.forEach(([v, s]) => {
                const text = `${v}: –í—ã—Ä—É—á–∫–∞ ${fmt.format((s.total_revenue || 0).toFixed(0))} ‚ÇΩ, –ó–∞–∫–∞–∑—ã ${s.total_orders || 0}`;
                doc.text(escapeText(text), 10, y);
                y += 7;
                if (y > 280) {
                    doc.addPage();
                    y = 15;
                }
            });
            doc.save(`chifan_report_${currentStartDate.replace(/-/g, '_')}_${filter}.pdf`);
            showToast('PDF —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!');
        }
        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        if (localStorage.getItem('theme') === 'dark') toggleTheme();
        const todayStr = getTodayDateString();
        document.getElementById('start-date').value = todayStr;
        document.getElementById('end-date').value = todayStr;
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É "–°–µ–≥–æ–¥–Ω—è" –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.querySelector('.period-btn').classList.add('active');
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∏–∑–Ω–µ—Å-–¥–Ω–µ
        updateBusinessDayInfo();
        load(todayStr, todayStr); 
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        setupAutoRefresh();
        function updateBusinessDayInfo() {
            const businessDayDate = getCurrentBusinessDay().toISOString().split('T')[0];
            document.getElementById('business-day-date').textContent = businessDayDate;
        }
    </script>
</body>
</html>
